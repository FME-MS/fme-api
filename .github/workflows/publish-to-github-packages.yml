name: Generate & Publish TS Clients

permissions:
  contents: read    # so your build steps can clone and read code
  packages: write   # so you can publish to GitHub Packages

on:
  push:
    branches:
      - develop
      - main

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '21'

      - name: Set up Node.js 22
        uses: actions/setup-node@v3
        with:
          node-version: '22'
          registry-url: https://npm.pkg.github.com
          scope: '@fme-api'

      - name: Configure Maven for GitHub Packages
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml <<EOF
          <settings>
            <servers>
              <server>
                <id>github</id>
                <username>${{ github.actor }}</username>
                <password>${{ secrets.GITHUB_TOKEN }}</password>
              </server>
            </servers>
          </settings>
          EOF

      - name: Maven package (generate sources)
        run: mvn clean install -P generate-npm -P generate-java -DskipTests


      - name: Get project version
        id: get-version
        run: |
          echo "VERSION=$(mvn help:evaluate \
            -Dexpression=project.version -q -DforceStdout)" >> $GITHUB_ENV

      - name: Publish .jar file
        working-directory: .
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mvn deploy -DskipTests

      - name: Publish npm packages
        working-directory: .
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Looking for generated clients in openapi-codegen/…"
          cp .npmrc ./openapi-codegen/.npmrc
          
          for pkg in openapi-codegen/*/; do
          pkg_name=$(basename "${pkg%/}")
            if [ -f "$pkg/package.json" ]; then
              (
              cd "$pkg"
          
              NAME=$(jq -r .name package.json)
              VERSION=$(jq -r .version package.json)
              REPO=fme-api
              OWNER=${GITHUB_REPOSITORY_OWNER}
              echo "   • Deleting existing snapshot versions of $OWNER for $NAME@$VERSION…"
              echo "Calling route: /${OWNER}/${REPO}/pkgs/npm/${pkg_name}/versions"
              gh api \
                /${OWNER}/${REPO}/pkgs/npm/${pkg_name}/versions \
                -q ".[] | select(.metadata.package_version==\"${VERSION}\") | .id" \
                | while read id; do
                    echo "     – deleting version id $id"
                    echo "Calling route: /orgs/${OWNER}/packages/npm/${pkg}/${id}"
                    gh api -X DELETE \
                      /orgs/${OWNER}/packages/npm/${pkg}/versions/${id}
                  done

                echo "   • Publishing $NAME@$VERSION"
              cd dist
              npm publish
              )
            fi
          done
